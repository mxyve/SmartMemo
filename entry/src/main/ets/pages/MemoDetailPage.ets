/**
 * å¤‡å¿˜å½•è¯¦æƒ…é¡µé¢ - ä½¿ç”¨å°è£…çš„æ—¶é—´é€‰æ‹©å™¨ç»„ä»¶
 */

import { router } from '@kit.ArkUI';
import { MemoItem } from '../model/MemoItem';
import { StorageService } from '../service/StorageService';
import { ThemeManager } from '../utils/ThemeManager';
import { AppConstants } from '../constants/AppConstants';
import { TimePickerComponent, TimePickerController } from '../components/TimePicker';

@Entry
@Component
export struct MemoDetailPage {
  @State private memo: MemoItem = new MemoItem();
  @State private isEditMode: boolean = false;
  @State private themeManager: ThemeManager = ThemeManager.getInstance();
  @State private storageService: StorageService = StorageService.getInstance();
  @State private title: string = '';
  @State private content: string = '';
  @State private isSaving: boolean = false;
  private routerParams: Record<string, Object> = {};
  // ğŸ”¥ å…³é”®ï¼šæ§åˆ¶å™¨å¿…é¡»æ˜¯ @State
  @State timePickerController: TimePickerController = new TimePickerController();

  aboutToAppear(): void {
    this.routerParams = router.getParams() as Record<string, Object>;
    this.initializePage();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å·¥å…·æ 
      this.buildToolbar()

      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // æ ‡é¢˜è¾“å…¥
          this.buildTitleInput()

          // å†…å®¹è¾“å…¥
          this.buildContentInput()

          // æé†’è®¾ç½®
          this.buildReminderSection()
        }
        .padding(AppConstants.SPACING.MEDIUM)
      }
      .layoutWeight(1)

      // åº•éƒ¨æ“ä½œæ 
      this.buildBottomActions()

      // ğŸ”¥ æ—¶é—´é€‰æ‹©å™¨ç»„ä»¶ - ä½¿ç”¨åŒå‘ç»‘å®š
      TimePickerComponent({
        controller: $timePickerController
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.themeManager.getBackgroundColor())
  }

  /**
   * æ„å»ºé¡¶éƒ¨å·¥å…·æ 
   */
  @Builder
  buildToolbar() {
    Row() {
      // è¿”å›æŒ‰é’®
      Button() {
        Image($r('app.media.arrow_left'))
          .width(24)
          .height(24)
          .fillColor(this.themeManager.getPrimaryTextColor())
      }
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        this.onBackPressed();
      })

      Text(this.isEditMode ? 'ç¼–è¾‘å¤‡å¿˜å½•' : 'æ–°å»ºå¤‡å¿˜å½•')
        .fontSize(this.themeManager.getScaledFontSize(AppConstants.FONT_SIZE.TITLE))
        .fontWeight(FontWeight.Medium)
        .fontColor(this.themeManager.getPrimaryTextColor())
        .margin({ left: AppConstants.SPACING.MEDIUM })

      Blank()

      // ä¿å­˜æŒ‰é’®
      Button() {
        if (this.isSaving) {
          LoadingProgress()
            .width(20)
            .height(20)
            .color(this.themeManager.getPrimaryColor())
        } else {
          Image($r('app.media.save'))
            .width(24)
            .height(24)
            .fillColor(this.themeManager.getPrimaryColor())
        }
      }
      .backgroundColor(Color.Transparent)
      .enabled(!this.isSaving)
      .onClick(() => {
        this.saveMemo();
      })
    }
    .width('100%')
    .height(AppConstants.UI.HEADER_HEIGHT)
    .padding({
      left: AppConstants.SPACING.MEDIUM,
      right: AppConstants.SPACING.MEDIUM
    })
  }

  /**
   * æ„å»ºæ ‡é¢˜è¾“å…¥
   */
  @Builder
  buildTitleInput() {
    Column() {
      Text('æ ‡é¢˜')
        .fontSize(this.themeManager.getScaledFontSize(AppConstants.FONT_SIZE.MEDIUM))
        .fontColor(this.themeManager.getSecondaryTextColor())
        .alignSelf(ItemAlign.Start)

      TextInput({
        placeholder: 'è¯·è¾“å…¥å¤‡å¿˜å½•æ ‡é¢˜...',
        text: this.title
      })
        .fontSize(this.themeManager.getScaledFontSize(AppConstants.FONT_SIZE.LARGE))
        .fontColor(this.themeManager.getPrimaryTextColor())
        .backgroundColor(this.themeManager.getSurfaceColor())
        .borderRadius(AppConstants.UI.BORDER_RADIUS_MEDIUM)
        .padding(AppConstants.SPACING.MEDIUM)
        .margin({ top: AppConstants.SPACING.SMALL })
        .onChange((value: string) => {
          this.title = value;
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .margin({ bottom: AppConstants.SPACING.LARGE })
  }

  /**
   * æ„å»ºå†…å®¹è¾“å…¥
   */
  @Builder
  buildContentInput() {
    Column() {
      Text('å†…å®¹')
        .fontSize(this.themeManager.getScaledFontSize(AppConstants.FONT_SIZE.MEDIUM))
        .fontColor(this.themeManager.getSecondaryTextColor())
        .alignSelf(ItemAlign.Start)

      TextArea({
        placeholder: 'è¯·è¾“å…¥å¤‡å¿˜å½•å†…å®¹...',
        text: this.content
      })
        .fontSize(this.themeManager.getScaledFontSize(AppConstants.FONT_SIZE.MEDIUM))
        .fontColor(this.themeManager.getPrimaryTextColor())
        .backgroundColor(this.themeManager.getSurfaceColor())
        .borderRadius(AppConstants.UI.BORDER_RADIUS_MEDIUM)
        .padding(AppConstants.SPACING.MEDIUM)
        .margin({ top: AppConstants.SPACING.SMALL })
        .height(200)
        .onChange((value: string) => {
          this.content = value;
        })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .margin({ bottom: AppConstants.SPACING.LARGE })
  }

  /**
   * æ„å»ºæé†’è®¾ç½®
   */
  @Builder
  buildReminderSection() {
    Row() {
      Text('æé†’æ—¶é—´')
        .fontSize(this.themeManager.getScaledFontSize(AppConstants.FONT_SIZE.MEDIUM))
        .fontColor(this.themeManager.getSecondaryTextColor())

      Blank()

      Button() {
        Row() {
          Image($r('app.media.alarm'))
            .width(16)
            .height(16)
            .fillColor(this.memo.reminderTime ? this.themeManager.getPrimaryColor() :
              this.themeManager.getSecondaryTextColor())

          Text(this.memo.reminderTime ? this.formatReminderTime(this.memo.reminderTime) : 'è®¾ç½®æé†’')
            .fontSize(this.themeManager.getScaledFontSize(AppConstants.FONT_SIZE.MEDIUM))
            .fontColor(this.memo.reminderTime ? this.themeManager.getPrimaryColor() :
              this.themeManager.getSecondaryTextColor())
            .margin({ left: AppConstants.SPACING.SMALL })

          Image($r('app.media.arrow_right'))
            .width(16)
            .height(16)
            .fillColor(this.themeManager.getSecondaryTextColor())
            .margin({ left: AppConstants.SPACING.SMALL })
        }
      }
      .backgroundColor(this.themeManager.getSurfaceColor())
      .borderRadius(AppConstants.UI.BORDER_RADIUS_MEDIUM)
      .padding({
        left: AppConstants.SPACING.MEDIUM,
        right: AppConstants.SPACING.MEDIUM,
        top: AppConstants.SPACING.SMALL,
        bottom: AppConstants.SPACING.SMALL
      })
      .onClick(() => {
        console.log('ç‚¹å‡»è®¾ç½®æé†’æŒ‰é’®');
        // ğŸ”¥ è®¾ç½®å›è°ƒå¹¶æ‰“å¼€å¯¹è¯æ¡†
        this.timePickerController.setCallbacks(
          this.onTimePickerCancel.bind(this),
          this.onTimePickerConfirm.bind(this)
        );
        this.timePickerController.openDialog();
      })
    }
    .width('100%')
    .margin({ bottom: AppConstants.SPACING.LARGE })
  }

  /**
   * æ„å»ºåº•éƒ¨æ“ä½œæ 
   */
  @Builder
  buildBottomActions() {
    Row() {
      // å–æ¶ˆæŒ‰é’®
      Button('å–æ¶ˆ')
        .fontSize(this.themeManager.getScaledFontSize(AppConstants.FONT_SIZE.MEDIUM))
        .fontColor(this.themeManager.getSecondaryTextColor())
        .backgroundColor(Color.Transparent)
        .borderWidth(1)
        .borderColor(this.themeManager.getDividerColor())
        .borderRadius(AppConstants.UI.BORDER_RADIUS_MEDIUM)
        .layoutWeight(1)
        .height(AppConstants.UI.BUTTON_HEIGHT)
        .onClick(() => {
          this.onBackPressed();
        })

      Blank()
        .width(AppConstants.SPACING.MEDIUM)

      // ä¿å­˜æŒ‰é’®
      Button('ä¿å­˜')
        .fontSize(this.themeManager.getScaledFontSize(AppConstants.FONT_SIZE.MEDIUM))
        .fontColor(Color.White)
        .backgroundColor(this.themeManager.getPrimaryColor())
        .borderRadius(AppConstants.UI.BORDER_RADIUS_MEDIUM)
        .layoutWeight(1)
        .height(AppConstants.UI.BUTTON_HEIGHT)
        .enabled(!this.isSaving)
        .onClick(() => {
          this.saveMemo();
        })
    }
    .width('100%')
    .padding(AppConstants.SPACING.MEDIUM)
    .backgroundColor(this.themeManager.getSurfaceColor())
  }

  /**
   * æ—¶é—´é€‰æ‹©å™¨å–æ¶ˆå›è°ƒ
   */
  private onTimePickerCancel(): void {
    console.log('æ—¶é—´é€‰æ‹©å–æ¶ˆ');
  }

  /**
   * æ—¶é—´é€‰æ‹©å™¨ç¡®è®¤å›è°ƒ
   */
  private onTimePickerConfirm(timestamp: number): void {
    this.memo.reminderTime = timestamp;
    console.log('è®¾ç½®æé†’æ—¶é—´:', new Date(timestamp).toLocaleString());
  }

  /**
   * åˆå§‹åŒ–é¡µé¢
   */
  private async initializePage(): Promise<void> {
    const mode = this.routerParams['mode'] as string;
    this.isEditMode = mode === 'edit';

    if (this.isEditMode) {
      const memoId = this.routerParams['memoId'] as string;
      await this.loadMemo(memoId);
    }

    this.title = this.memo.title;
    this.content = this.memo.content;
  }

  /**
   * åŠ è½½å¤‡å¿˜å½•
   */
  private async loadMemo(memoId: string): Promise<void> {
    try {
      const memos = await this.storageService.loadMemos();
      const foundMemo = memos.find(m => m.id === memoId);
      if (foundMemo) {
        this.memo = foundMemo;
      }
    } catch (error) {
      console.error('Load memo failed:', error);
    }
  }

  /**
   * ä¿å­˜å¤‡å¿˜å½•
   */
  private async saveMemo(): Promise<void> {
    if (!this.title.trim()) {
      AlertDialog.show({
        title: 'æç¤º',
        message: 'è¯·è¾“å…¥å¤‡å¿˜å½•æ ‡é¢˜',
        primaryButton: {
          value: 'ç¡®å®š',
          action: () => {
          }
        }
      });
      return;
    }

    this.isSaving = true;

    try {
      this.memo.title = this.title.trim();
      this.memo.content = this.content.trim();
      this.memo.updateTimeStamp();

      await this.storageService.saveMemo(this.memo);

      // è¿”å›ä¸Šä¸€é¡µ
      router.back();
    } catch (error) {
      console.error('Save memo failed:', error);
      AlertDialog.show({
        title: 'é”™è¯¯',
        message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•',
        primaryButton: {
          value: 'ç¡®å®š',
          action: () => {
          }
        }
      });
    } finally {
      this.isSaving = false;
    }
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  private onBackPressed(): void {
    if (this.hasUnsavedChanges()) {
      AlertDialog.show({
        title: 'ç¡®è®¤é€€å‡º',
        message: 'æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦é€€å‡ºå—ï¼Ÿ',
        primaryButton: {
          value: 'å–æ¶ˆ',
          action: () => {
          }
        },
        secondaryButton: {
          value: 'é€€å‡º',
          fontColor: this.themeManager.getErrorColor(),
          action: () => {
            router.back();
          }
        }
      });
    } else {
      router.back();
    }
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
   */
  private hasUnsavedChanges(): boolean {
    return this.title !== this.memo.title ||
      this.content !== this.memo.content;
  }

  /**
   * æ ¼å¼åŒ–æé†’æ—¶é—´
   */
  private formatReminderTime(timestamp: number): string {
    const date = new Date(timestamp);
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const reminderDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

    const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

    if (reminderDate.getTime() === today.getTime()) {
      return `ä»Šå¤© ${timeStr}`;
    } else if (reminderDate.getTime() === today.getTime() + 24 * 60 * 60 * 1000) {
      return `æ˜å¤© ${timeStr}`;
    } else {
      return `${date.getMonth() + 1}/${date.getDate()} ${timeStr}`;
    }
  }
}