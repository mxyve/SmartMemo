/**
 * ä¸»é¡µé¢ - TabBarå¯¼èˆªç»“æ„
 */

import { router } from '@kit.ArkUI';
import { window } from '@kit.ArkUI'; // ğŸ”¥ æ–°å¢å¯¼å…¥
import { MemoListPage } from './MemoListPage';
import { SettingsPage } from './SettingsPage';
import { AppConstants } from '../constants/AppConstants';

interface TabBarItem {
  text: string;
  icon: Resource;
  selectedIcon: Resource;
}

@Entry
@Component
struct MainPage {
  @State currentTabIndex: number = 0;
  @State showFloatingButton: boolean = true;
  @State refreshTrigger: number = 0;
  // ğŸ”¥ æ–°å¢ï¼šå®‰å…¨åŒºåŸŸçŠ¶æ€
  @State statusBarHeight: number = 0;
  @State navigationBarHeight: number = 0;
  // TabBaré…ç½®
  private tabBarData: TabBarItem[] = [
    {
      text: 'å¤‡å¿˜å½•',
      icon: $r('app.media.memo'),
      selectedIcon: $r('app.media.memo')
    },
    {
      text: 'åˆ†ç±»',
      icon: $r('app.media.category'),
      selectedIcon: $r('app.media.category')
    },
    {
      text: 'è®¾ç½®',
      icon: $r('app.media.settings'),
      selectedIcon: $r('app.media.settings')
    }
  ];

  aboutToAppear(): void {
    // ğŸ”¥ æ–°å¢ï¼šè·å–ç³»ç»Ÿæ é«˜åº¦
    this.getSystemBarHeights();
  }

  /**
   * ğŸ”¥ æ–°å¢ï¼šè·å–ç³»ç»Ÿæ é«˜åº¦
   */
  private async getSystemBarHeights(): Promise<void> {
    try {
      const win = await window.getLastWindow(getContext(this));
      const avoidArea = win.getWindowAvoidArea(window.AvoidAreaType.TYPE_SYSTEM);

      // çŠ¶æ€æ é«˜åº¦ï¼ˆé¡¶éƒ¨ï¼‰
      this.statusBarHeight = avoidArea.topRect.height;
      // å¯¼èˆªæ é«˜åº¦ï¼ˆåº•éƒ¨ï¼‰
      this.navigationBarHeight = avoidArea.bottomRect.height;

      console.info(`çŠ¶æ€æ é«˜åº¦: ${this.statusBarHeight}, å¯¼èˆªæ é«˜åº¦: ${this.navigationBarHeight}`);
    } catch (error) {
      console.error('è·å–ç³»ç»Ÿæ é«˜åº¦å¤±è´¥:', error);
      // è®¾ç½®é»˜è®¤å€¼
      this.statusBarHeight = 60;
      this.navigationBarHeight = 60;
    }
  }

  onPageShow(): void {
    // é¡µé¢æ˜¾ç¤ºæ—¶è§¦å‘åˆ·æ–°
    this.refreshTrigger = Date.now();
  }

  build() {
    Stack() {
      // ğŸ”¥ ä¿®æ­£ï¼šå®‰å…¨åŒºåŸŸå ä½å’Œä¸»è¦å†…å®¹
      Column() {
        // çŠ¶æ€æ å ä½ï¼ˆé˜²æ­¢å†…å®¹ä¸çŠ¶æ€æ é‡å ï¼‰
        Row()
          .width('100%')
          .height(this.statusBarHeight)
          .backgroundColor('transparent')

        // ä¸»è¦å†…å®¹åŒºåŸŸ
        Tabs({
          barPosition: BarPosition.End,
          index: this.currentTabIndex
        }) {
          // å¤‡å¿˜å½•é¡µé¢
          TabContent() {
            MemoListPage({ refreshTrigger: this.refreshTrigger })
          }
          .tabBar(this.buildTabBarItem(0))

          // åˆ†ç±»é¡µé¢
          TabContent() {
            this.buildCategoryPage()
          }
          .tabBar(this.buildTabBarItem(1))

          // è®¾ç½®é¡µé¢
          TabContent() {
            SettingsPage()
          }
          .tabBar(this.buildTabBarItem(2))
        }
        .onChange((index: number) => {
          this.currentTabIndex = index;
          // åœ¨åˆ†ç±»å’Œè®¾ç½®é¡µé¢éšè—æ‚¬æµ®æŒ‰é’®
          this.showFloatingButton = index === 0;
        })
        .animationDuration(AppConstants.ANIMATION.DURATION_NORMAL)
        .backgroundColor('transparent')
        .layoutWeight(1) // ğŸ”¥ æ–°å¢ï¼šç¡®ä¿Tabså¡«æ»¡ç©ºé—´

        // ğŸ”¥ ä¿®æ­£ï¼šå¯¼èˆªæ å ä½ç§»åˆ°Tabså¤–éƒ¨
        Row()
          .width('100%')
          .height(this.navigationBarHeight)
          .backgroundColor('transparent')
      }
      .width('100%')
      .height('100%')

      // ğŸ”¥ ä¿®æ­£ï¼šæ‚¬æµ®æŒ‰é’®æ”¾åœ¨Stackçš„æœ€å¤–å±‚
      if (this.showFloatingButton) {
        Button() {
          Text('+')
            .fontSize(28)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
        }
        .width(56)
        .height(56)
        .borderRadius(28)
        .backgroundColor($r('app.color.primary_color'))
        .shadow({
          radius: 16,
          color: 'rgba(0, 125, 255, 0.4)',
          offsetY: 4
        })
        .onClick(() => {
          this.onAddButtonClick();
        })
        .position({
          x: '100%',
          y: '100%'
        })
        .markAnchor({
          x: 72, // æŒ‰é’®å®½åº¦56 + å³è¾¹è·16
          y: 128 // æŒ‰é’®é«˜åº¦56 + åº•éƒ¨è¾¹è·16 + TabBaré«˜åº¦56 + å¯¼èˆªæ é«˜åº¦
        })
        .animation({
          duration: AppConstants.ANIMATION.DURATION_NORMAL,
          curve: Curve.EaseInOut
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background_light'))
  }

  /**
   * æ„å»ºTabBaré¡¹
   */
  @Builder
  buildTabBarItem(index: number) {
    Column() {
      // å›¾æ ‡åŒºåŸŸï¼Œæ·»åŠ èƒŒæ™¯åœ†åœˆ
      Stack() {
        if (this.currentTabIndex === index) {
          Circle()
            .width(32)
            .height(32)
            .fill($r('app.color.primary_color'))
            .opacity(0.15)
        }

        Image(this.currentTabIndex === index ?
          this.tabBarData[index].selectedIcon :
          this.tabBarData[index].icon)
          .width(22)
          .height(22)
          .fillColor(this.currentTabIndex === index ?
            $r('app.color.primary_color') :
            $r('app.color.text_secondary_light'))
      }
      .width(32)
      .height(32)

      // æ–‡æœ¬æ ‡ç­¾
      Text(this.tabBarData[index].text)
        .fontSize(11)
        .fontWeight(this.currentTabIndex === index ? FontWeight.Medium : FontWeight.Normal)
        .fontColor(this.currentTabIndex === index ?
          $r('app.color.primary_color') :
          $r('app.color.text_secondary_light'))
        .margin({ top: 4 })
        .maxLines(1)
    }
    .width('100%')
    .height('100%')
    .padding({ top: 6, bottom: 6 })
    .justifyContent(FlexAlign.Center)
    .animation({
      duration: 200,
      curve: Curve.EaseInOut
    })
  }

  /**
   * æ„å»ºåˆ†ç±»é¡µé¢
   */
  @Builder
  buildCategoryPage() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('åˆ†ç±»ç®¡ç†')
          .fontSize(AppConstants.FONT_SIZE.TITLE)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary_light'))

        Blank()

        Image($r('app.media.new'))
          .width(24)
          .height(24)
          .onClick(() => {
            this.onAddCategoryClick();
          })
      }
      .width('100%')
      .height(AppConstants.UI.HEADER_HEIGHT)
      .padding({
        left: AppConstants.SPACING.MEDIUM,
        right: AppConstants.SPACING.MEDIUM
      })

      Divider()
        .color($r('app.color.priority_high'))

      // åˆ†ç±»åˆ—è¡¨åŒºåŸŸ
      Column() {
        Text('åˆ†ç±»åŠŸèƒ½å¼€å‘ä¸­...')
          .fontSize(AppConstants.FONT_SIZE.MEDIUM)
          .fontColor($r('app.color.text_secondary_light'))
          .margin({ top: AppConstants.SPACING.EXTRA_LARGE })
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background_light'))
  }

  /**
   * æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
   */
  private onAddButtonClick(): void {
    // å¯¼èˆªåˆ°æ·»åŠ å¤‡å¿˜å½•é¡µé¢
    router.pushUrl({
      url: 'pages/MemoDetailPage',
      params: {
        mode: 'add'
      }
    }).catch((error: Error) => {
      console.error('Navigate to memo detail failed:', error);
    });
  }

  /**
   * æ·»åŠ åˆ†ç±»æŒ‰é’®ç‚¹å‡»äº‹ä»¶
   */
  private onAddCategoryClick(): void {
    // TODO: å®ç°æ·»åŠ åˆ†ç±»åŠŸèƒ½
    console.log('Add category clicked');
  }
}