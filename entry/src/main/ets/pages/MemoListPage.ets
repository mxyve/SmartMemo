/**
 * å¤‡å¿˜å½•åˆ—è¡¨é¡µé¢
 */

import { router } from '@kit.ArkUI';
import { MemoItem } from '../model/MemoItem';
import { MemoListViewModel } from '../viewmodel/MemoListViewModel';
import { ThemeManager } from '../utils/ThemeManager';
import { AppConstants, SortType, FilterType } from '../constants/AppConstants';

@Entry
@Component
export struct MemoListPage {
  @State private viewModel: MemoListViewModel = new MemoListViewModel();
  @State private themeManager: ThemeManager = ThemeManager.getInstance();
  @State private showSearchBar: boolean = false;
  @State private searchText: string = '';
  @Prop @Watch('onRefreshTriggered') refreshTrigger: number = 0;

  aboutToAppear(): void {
    this.viewModel.initialize();
  }

  onPageShow(): void {
    // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®
    this.viewModel.refresh();
  }

  onRefreshTriggered(): void {
    // å¤–éƒ¨è§¦å‘åˆ·æ–°
    this.viewModel.refresh();
  }

  /**
   * æ ¼å¼åŒ–åˆ—è¡¨ä¸­çš„æé†’æ—¶é—´æ˜¾ç¤º
   */
  private formatReminderTimeForList(timestamp: number): string {
    const now = new Date();
    const reminderDate = new Date(timestamp);
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const reminderDay = new Date(reminderDate.getFullYear(), reminderDate.getMonth(), reminderDate.getDate());

    const timeStr =
      `${reminderDate.getHours().toString().padStart(2, '0')}:${reminderDate.getMinutes().toString().padStart(2, '0')}`;

    // è®¡ç®—å¤©æ•°å·®
    const dayDiff = Math.floor((reminderDay.getTime() - today.getTime()) / (24 * 60 * 60 * 1000));

    if (dayDiff === 0) {
      return `ä»Šå¤© ${timeStr}`;
    } else if (dayDiff === 1) {
      return `æ˜å¤© ${timeStr}`;
    } else if (dayDiff === 2) {
      return `åå¤© ${timeStr}`;
    } else if (dayDiff > 2 && dayDiff < 7) {
      const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
      const weekDay = weekDays[reminderDate.getDay()];
      return `å‘¨${weekDay} ${timeStr}`;
    } else {
      return `${reminderDate.getMonth() + 1}æœˆ${reminderDate.getDate()}æ—¥ ${timeStr}`;
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å·¥å…·æ 
      this.buildToolbar()
      // æœç´¢æ 
      if (this.showSearchBar) {
        this.buildSearchBar()
      }
      // å¤‡å¿˜å½•åˆ—è¡¨
      this.buildMemoList()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.themeManager.getBackgroundColor())
  }

  /**
   * æ„å»ºé¡¶éƒ¨å·¥å…·æ 
   */
  @Builder
  buildToolbar() {
    Row() {
      Text('å¤‡å¿˜å½•')
        .fontSize(this.themeManager.getScaledFontSize(AppConstants.FONT_SIZE.TITLE))
        .fontWeight(FontWeight.Bold)
        .fontColor(this.themeManager.getPrimaryTextColor())
      Blank()
      // æœç´¢æŒ‰é’®
      Button() {
        Image($r('app.media.search'))
          .width(20)
          .height(20)
          .fillColor(this.themeManager.getPrimaryTextColor())
      }
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        this.showSearchBar = !this.showSearchBar;
        if (!this.showSearchBar) {
          this.searchText = '';
          this.viewModel.searchMemos('');
        }
      })

    }
    .width('100%')
    .height(AppConstants.UI.HEADER_HEIGHT)
    .padding({
      left: AppConstants.SPACING.MEDIUM,
      right: AppConstants.SPACING.MEDIUM
    })
  }

  /**
   * æ„å»ºæœç´¢æ 
   */
  @Builder
  buildSearchBar() {
    Row() {
      TextInput({
        placeholder: 'æœç´¢å¤‡å¿˜å½•...',
        text: this.searchText
      })
        .layoutWeight(1)
        .height(40)
        .borderRadius(AppConstants.UI.BORDER_RADIUS_MEDIUM)
        .backgroundColor(this.themeManager.getSurfaceColor())
        .onChange((value: string) => {
          this.searchText = value;
          this.viewModel.searchMemos(value);
        })

      Button() {
        Image($r('app.media.clear'))
          .width(16)
          .height(16)
          .fillColor(this.themeManager.getSecondaryTextColor())
      }
      .width(32)
      .height(32)
      .backgroundColor(Color.Transparent)
      .margin({ left: AppConstants.SPACING.SMALL })
      .onClick(() => {
        this.showSearchBar = false;
        this.searchText = '';
        this.viewModel.searchMemos('');
      })
    }
    .width('100%')
    .padding({
      left: AppConstants.SPACING.MEDIUM,
      right: AppConstants.SPACING.MEDIUM,
      bottom: AppConstants.SPACING.SMALL
    })
    .animation({
      duration: AppConstants.ANIMATION.DURATION_NORMAL,
      curve: Curve.EaseInOut
    })
  }

  /**
   * æ„å»ºå¤‡å¿˜å½•åˆ—è¡¨
   */
  @Builder
  buildMemoList() {
    if (this.viewModel.isLoading) {
      // åŠ è½½ä¸­çŠ¶æ€
      Column() {
        LoadingProgress()
          .width(32)
          .height(32)
          .color(this.themeManager.getPrimaryColor())

        Text('åŠ è½½ä¸­...')
          .fontSize(this.themeManager.getScaledFontSize(AppConstants.FONT_SIZE.MEDIUM))
          .fontColor(this.themeManager.getSecondaryTextColor())
          .margin({ top: AppConstants.SPACING.MEDIUM })
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
    } else if (this.viewModel.filteredMemoList.length === 0) {
      // ç©ºçŠ¶æ€
      Column() {
        Image($r('app.media.ic_empty'))
          .width(120)
          .height(120)
          .opacity(0.6)

        Text('æš‚æ— å¤‡å¿˜å½•')
          .fontSize(this.themeManager.getScaledFontSize(AppConstants.FONT_SIZE.LARGE))
          .fontColor(this.themeManager.getSecondaryTextColor())
          .margin({ top: AppConstants.SPACING.LARGE })

        Text('ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®æ·»åŠ ç¬¬ä¸€æ¡å¤‡å¿˜å½•')
          .fontSize(this.themeManager.getScaledFontSize(AppConstants.FONT_SIZE.MEDIUM))
          .fontColor(this.themeManager.getSecondaryTextColor())
          .margin({ top: AppConstants.SPACING.SMALL })
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
    } else {
      // å¤‡å¿˜å½•åˆ—è¡¨
      List() {
        ForEach(this.viewModel.filteredMemoList, (memo: MemoItem, index: number) => {
          ListItem() {
            this.buildMemoCard(memo, index)
          }
          .swipeAction({
            end: this.buildSwipeActions(memo)
          })
          .onClick(() => {
            if (this.viewModel.isSelectionMode) {
              this.viewModel.toggleMemoSelection(memo.id);
            } else {
              this.navigateToMemoDetail(memo);
            }
          })
        }, (memo: MemoItem) => memo.id)
      }
      .layoutWeight(1)
      .width('95%')
      .height('100%')
      .padding({
        top: 8,
        bottom: AppConstants.SPACING.MEDIUM
      })
      .alignSelf(ItemAlign.Center)
    }
  }

  /**
   * æ„å»ºå¤‡å¿˜å½•å¡ç‰‡
   */
  @Builder
  buildMemoCard(memo: MemoItem, index: number) {
    Column() {
      Row() {
        // æ¡ä»¶æ˜¾ç¤ºé€‰æ‹©æ¡† - åªåœ¨é€‰æ‹©æ¨¡å¼ä¸‹æ˜¾ç¤º
        if (this.viewModel.isSelectionMode) {
          Checkbox({
            name: memo.id, // ä½¿ç”¨å¤‡å¿˜å½•IDä½œä¸ºå”¯ä¸€æ ‡è¯†
            group: 'memoSelection' // åˆ†ç»„ç®¡ç†é€‰æ‹©æ¡†
          })
            .select(this.viewModel.selectedMemos.has(memo.id)) // æ ¹æ®é€‰ä¸­çŠ¶æ€è®¾ç½®å‹¾é€‰
            .onChange((value: boolean) => {
              // é€‰æ‹©çŠ¶æ€æ”¹å˜æ—¶é€šçŸ¥ViewModelæ›´æ–°é€‰ä¸­é›†åˆ
              this.viewModel.toggleMemoSelection(memo.id);
            })
            .margin({ right: AppConstants.SPACING.SMALL })
        }

        // ä¸»è¦å†…å®¹åŒºåŸŸ
        Column() {
          // æ ‡é¢˜è¡Œ - åŒ…å«æ ‡é¢˜æ–‡æœ¬å’ŒçŠ¶æ€å›¾æ ‡
          Row() {
            Text(memo.title || 'æ— æ ‡é¢˜') // æ˜¾ç¤ºæ ‡é¢˜ï¼Œç©ºæ ‡é¢˜æ—¶æ˜¾ç¤ºå ä½æ–‡æœ¬
              .fontSize(this.themeManager.getScaledFontSize(AppConstants.FONT_SIZE.LARGE))
              .fontWeight(FontWeight.Medium)
              .fontColor(this.themeManager.getPrimaryTextColor())
              .maxLines(1) // é™åˆ¶å•è¡Œæ˜¾ç¤º
              .textOverflow({ overflow: TextOverflow.Ellipsis }) // è¶…é•¿æ–‡æœ¬æ˜¾ç¤ºçœç•¥å·
              .layoutWeight(1) // å ç”¨å‰©ä½™ç©ºé—´

            // çŠ¶æ€å›¾æ ‡ç»„ - æ˜¾ç¤ºæ˜Ÿæ ‡å’Œå®ŒæˆçŠ¶æ€
            Row() {
              if (memo.isStarred) {
                Text('â­') // æ˜Ÿæ ‡å›¾æ ‡
                  .fontSize(16)
                  .margin({ left: 4 })
              }
              if (memo.isCompleted) {
                Text('âœ…') // å®ŒæˆçŠ¶æ€å›¾æ ‡
                  .fontSize(16)
                  .margin({ left: 4 })
              }
            }
          }
          .width('100%')
          .alignItems(VerticalAlign.Center)

          // å†…å®¹é¢„è§ˆï¼ˆåªæœ‰åœ¨æœ‰å†…å®¹æ—¶æ‰æ˜¾ç¤ºï¼Œå¹¶ä¸”åªæ˜¾ç¤ºä¸€è¡Œï¼‰
          if (memo.content && memo.content.trim()) {
            Text(memo.content)
              .fontSize(13)
              .fontColor(this.themeManager.getSecondaryTextColor())
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .margin({ top: 4 })
              .width('100%')
          }

          // ğŸ”¥ æ–°å¢ï¼šæé†’æ—¶é—´æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰æé†’æ—¶é—´ï¼‰
          if (memo.reminderTime && memo.reminderTime > 0) {
            Row() {
              Image($r('app.media.alarm')) // æé†’é—¹é’Ÿå›¾æ ‡
                .width(12)
                .height(12)
                .fillColor(this.themeManager.getPrimaryColor())
                .margin({ right: 4 })

              Text(this.formatReminderTimeForList(memo.reminderTime))
                .fontSize(11)
                .fontColor(this.themeManager.getPrimaryColor())
                .fontWeight(FontWeight.Medium)
            }
            .width('100%')
            .margin({ top: 4 })
            .alignItems(VerticalAlign.Center)
          }


          // åº•éƒ¨ä¿¡æ¯è¡Œ - æ˜¾ç¤ºæ ‡ç­¾ã€ä¼˜å…ˆçº§ã€åŠŸèƒ½å›¾æ ‡å’Œæ—¶é—´
          Row() {


            // // åŠŸèƒ½å›¾æ ‡æŒ‡ç¤ºå™¨ - æ˜¾ç¤ºå¤‡å¿˜å½•çš„ç‰¹æ®Šå±æ€§
            // if (memo.reminderTime) {
            //   Image($r('app.media.alarm')) // æé†’é—¹é’Ÿå›¾æ ‡
            //     .width(10)
            //     .height(10)
            //     .margin({ right: 4 })
            // }

            Blank() // å¼¹æ€§ç©ºç™½åŒºåŸŸï¼Œå°†æ—¶é—´æ¨åˆ°å³ä¾§

            // æ›´æ–°æ—¶é—´ - æ˜¾ç¤ºç›¸å¯¹æ—¶é—´æ ¼å¼
            Text(this.formatTime(memo.updateTime))
              .fontSize(11)
              .fontColor(this.themeManager.getSecondaryTextColor())
          }
          .width('100%')
          .margin({ top: 6 })
          .alignItems(VerticalAlign.Center)
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .padding({ right: 16 })
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Center)
    .padding({
      left: 16,
      right: 16,
      top: 10,
      bottom: 10
    })
    .backgroundColor(this.themeManager.getSurfaceColor())
    .borderRadius(8)
    .margin({
      bottom: 6
    })
    .shadow({
      radius: 2,
      color: this.themeManager.isDarkMode ? 'rgba(0, 0, 0, 0.15)' : 'rgba(0, 0, 0, 0.04)',
      offsetY: 1
    })
    .animation({
      duration: AppConstants.ANIMATION.DURATION_SHORT,
      curve: Curve.EaseInOut
    })
    .opacity(memo.isCompleted ? 0.7 : 1.0)
  }

  /**
   * æ„å»ºæ»‘åŠ¨æ“ä½œ
   */
  @Builder
  buildSwipeActions(memo: MemoItem) {
    Row() {
      // æ˜Ÿæ ‡æŒ‰é’®
      Column() {
        // Image($r('app.media.star'))
        //   .width(22)
        //   .height(22)
        //   .fillColor(Color.White)

        Text(memo.isStarred ? 'å·²æ˜Ÿæ ‡' : 'åŠ æ˜Ÿæ ‡')
          .fontSize(14)
          .fontColor(Color.White)
          .margin({ top: 2 })
      }
      .width(72)
      .height('60%')
      .justifyContent(FlexAlign.Center)
      .backgroundColor(memo.isStarred ? '#FF9500' : '#FFD700')
      .onClick(async () => {
        await this.viewModel.toggleMemoStarred(memo.id);
      })
      .animation({
        duration: 200,
        curve: Curve.EaseInOut
      })

      // å®ŒæˆæŒ‰é’®
      Column() {
        // Image($r('app.media.finish'))
        //   .width(22)
        //   .height(22)
        //   .fillColor(Color.White)

        Text(memo.isCompleted ? 'å–æ¶ˆå®Œæˆ' : 'æ ‡è®°å®Œæˆ')
          .fontSize(14)
          .fontColor(Color.White)
          .margin({ top: 2 })
      }
      .width(72)
      .height('60%')
      .justifyContent(FlexAlign.Center)
      .backgroundColor(memo.isCompleted ? '#34C759' : '#30D158')
      .onClick(async () => {
        await this.viewModel.toggleMemoCompleted(memo.id);
      })
      .animation({
        duration: 200,
        curve: Curve.EaseInOut
      })

      // åˆ é™¤æŒ‰é’®
      Column() {
        // Image($r('app.media.delete'))
        //   .width(22)
        //   .height(22)
        //   .fillColor(Color.White)

        Text('åˆ é™¤')
          .fontSize(14)
          .fontColor(Color.White)
          .margin({ top: 2 })
      }
      .width(72)
      .height('60%')
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#FF3B30')
      .onClick(() => {
        this.showDeleteConfirmDialog(memo);
      })
      .animation({
        duration: 200,
        curve: Curve.EaseInOut
      })
    }
    .borderRadius(8)
    .shadow({
      radius: 4,
      color: 'rgba(0, 0, 0, 0.1)',
      offsetY: 2
    })
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´ - å°†æ—¶é—´æˆ³è½¬æ¢ä¸ºæ˜“è¯»çš„ç›¸å¯¹æ—¶é—´æ ¼å¼
   */
  private formatTime(timestamp: number): string {
    const now = Date.now(); // è·å–å½“å‰æ—¶é—´æˆ³
    const diff = now - timestamp; // è®¡ç®—æ—¶é—´å·®ï¼ˆæ¯«ç§’ï¼‰

    // å®šä¹‰æ—¶é—´å•ä½å¸¸é‡ï¼ˆæ¯«ç§’ï¼‰
    const minute = 60 * 1000; // 1åˆ†é’Ÿ = 60,000æ¯«ç§’
    const hour = 60 * minute; // 1å°æ—¶ = 60åˆ†é’Ÿ
    const day = 24 * hour; // 1å¤© = 24å°æ—¶

    // æ ¹æ®æ—¶é—´å·®è¿”å›ä¸åŒçš„æ ¼å¼
    if (diff < minute) {
      // å°äº1åˆ†é’Ÿæ˜¾ç¤º"åˆšåˆš"
      return 'åˆšåˆš';
    } else if (diff < hour) {
      // å°äº1å°æ—¶æ˜¾ç¤º"Xåˆ†é’Ÿå‰"
      return `${Math.floor(diff / minute)}åˆ†é’Ÿå‰`;
    } else if (diff < day) {
      // å°äº1å¤©æ˜¾ç¤º"Xå°æ—¶å‰"
      return `${Math.floor(diff / hour)}å°æ—¶å‰`;
    } else if (diff < 7 * day) {
      // å°äº7å¤©æ˜¾ç¤º"Xå¤©å‰"
      return `${Math.floor(diff / day)}å¤©å‰`;
    } else {
      // è¶…è¿‡7å¤©æ˜¾ç¤ºå…·ä½“æ—¥æœŸï¼ˆæœˆ/æ—¥æ ¼å¼ï¼‰
      const date = new Date(timestamp);
      return `${date.getMonth() + 1}/${date.getDate()}`; // getMonth()è¿”å›0-11ï¼Œéœ€è¦+1
    }
  }

  /**
   * å¯¼èˆªåˆ°å¤‡å¿˜å½•è¯¦æƒ…
   */
  private navigateToMemoDetail(memo: MemoItem): void {
    router.pushUrl({
      url: 'pages/MemoDetailPage',
      params: {
        mode: 'edit',
        memoId: memo.id
      }
    }).catch((error: Error) => {
      console.error('Navigate to memo detail failed:', error);
    });
  }

  /**
   * æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
   */
  private showDeleteConfirmDialog(memo: MemoItem): void {
    AlertDialog.show({
      title: 'ç¡®è®¤åˆ é™¤',
      message: `ç¡®å®šè¦åˆ é™¤å¤‡å¿˜å½•"${memo.title || 'æ— æ ‡é¢˜'}"å—ï¼Ÿ`,
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {
        }
      },
      secondaryButton: {
        value: 'åˆ é™¤',
        fontColor: this.themeManager.getErrorColor(), // åˆ é™¤ç¡®è®¤æŒ‰é’®ç”¨çº¢è‰²æ–‡å­—
        action: () => {
          this.viewModel.deleteMemo(memo.id);
        }
      }
    });
  }
}