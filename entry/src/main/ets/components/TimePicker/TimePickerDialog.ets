/**
 * æ—¶é—´é€‰æ‹©å™¨å¯¹è¯æ¡†ç»„ä»¶
 */

// ğŸ”¥ æ–°å¢ï¼šæ—¥æœŸå¯¹è±¡æ¥å£
interface DateObject {
  year: number;
  month: number;
  day: number;
}

@CustomDialog
export struct TimePickerDialog {
  controller?: CustomDialogController;
  // æ—¶é—´æ•°æ®
  @State dateList: string[] = this.generateDateList();
  @State hourList: string[] = this.generateHourList();
  @State minuteList: string[] = this.generateMinuteList();
  // é€‰ä¸­çš„å€¼
  @State selectedDate: string = '';
  @State selectedHour: string = '';
  @State selectedMinute: string = '';
  // å›è°ƒå‡½æ•°
  cancel: () => void = () => {
  };
  confirm: (timestamp: number) => void = () => {
  };

  aboutToAppear(): void {
    // è®¾ç½®é»˜è®¤é€‰ä¸­å½“å‰æ—¶é—´
    const now = new Date();
    this.selectedDate = this.dateList[0]; // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ—¥æœŸï¼ˆä»Šå¤©ï¼‰
    this.selectedHour = now.getHours().toString().padStart(2, '0');
    this.selectedMinute = now.getMinutes().toString().padStart(2, '0');
  }

  build() {
    Column() {
      // æ ‡é¢˜
      Row() {
        Text('è®¾ç½®æé†’æ—¶é—´')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#182431')
      }
      .padding({ bottom: 25 })
      .width('100%')
      .justifyContent(FlexAlign.Center)

      // æ—¶é—´é€‰æ‹©åŒºåŸŸ
      Flex({ justifyContent: FlexAlign.SpaceBetween, alignItems: ItemAlign.Center }) {
        // æ—¥æœŸé€‰æ‹©
        Column() {
          Text('æ—¥æœŸ')
            .fontSize(12)
            .fontColor('#666666')
            .margin({ bottom: 8 })

          TextPicker({ range: this.dateList })
            .width(140)
            .height(150)
            .onChange((value: string | string[]) => {
              if (typeof value === 'string') {
                this.selectedDate = value;
              }
            })
        }

        // å°æ—¶é€‰æ‹©
        Column() {
          Text('æ—¶')
            .fontSize(12)
            .fontColor('#666666')
            .margin({ bottom: 8 })

          TextPicker({ range: this.hourList })
            .width(80)
            .height(150)
            .onChange((value: string | string[]) => {
              if (typeof value === 'string') {
                this.selectedHour = value;
              }
            })
        }

        // åˆ†é’Ÿé€‰æ‹©
        Column() {
          Text('åˆ†')
            .fontSize(12)
            .fontColor('#666666')
            .margin({ bottom: 8 })

          TextPicker({ range: this.minuteList })
            .width(80)
            .height(150)
            .onChange((value: string | string[]) => {
              if (typeof value === 'string') {
                this.selectedMinute = value;
              }
            })
        }
      }
      .width('100%')
      .padding({ left: 10, right: 10 })

      // å½“å‰é€‰æ‹©çš„æ—¶é—´æ˜¾ç¤º
      Row() {
        Text(`é€‰æ‹©çš„æ—¶é—´: ${this.getSelectedDateDisplay()}`)
          .fontSize(14)
          .fontColor('#1976D2')
          .fontWeight(FontWeight.Medium)
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .margin({ top: 20 })

      // æŒ‰é’®åŒºåŸŸ
      Row() {
        Button('å–æ¶ˆ', { type: ButtonType.Normal, stateEffect: true })
          .margin({ right: 12 })
          .borderRadius(8)
          .backgroundColor('#F5F5F5')
          .fontColor('#666666')
          .borderWidth(0)
          .fontSize(16)
          .layoutWeight(1)
          .height(44)
          .onClick(() => {
            this.controller?.close();
            this.cancel();
          })

        Button('ç¡®å®š', { type: ButtonType.Normal, stateEffect: true })
          .margin({ left: 12 })
          .borderRadius(8)
          .fontSize(16)
          .backgroundColor('#1976D2')
          .fontColor(Color.White)
          .layoutWeight(1)
          .height(44)
          .onClick(() => {
            const timestamp = this.getSelectedTimestamp();
            if (timestamp > 0) {
              this.confirm(timestamp);
              this.controller?.close();
            } else {
              // æ—¶é—´è§£æå¤±è´¥å¤„ç†
              console.error('æ—¶é—´è§£æå¤±è´¥');
            }
          })
      }
      .justifyContent(FlexAlign.Center)
      .padding({ top: 25 })
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(16)
  }

  /**
   * ç”Ÿæˆæ—¥æœŸåˆ—è¡¨ï¼ˆæœªæ¥30å¤©ï¼Œå¸¦ä¸­æ–‡æ˜¾ç¤ºï¼‰
   */
  private generateDateList(): string[] {
    const dates: string[] = [];
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

    for (let i = 0; i < 30; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + i);

      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekDay = weekDays[date.getDay()];

      let displayText = '';
      if (i === 0) {
        displayText = `ä»Šå¤© (${month}æœˆ${day}æ—¥ å‘¨${weekDay})`;
      } else if (i === 1) {
        displayText = `æ˜å¤© (${month}æœˆ${day}æ—¥ å‘¨${weekDay})`;
      } else if (i === 2) {
        displayText = `åå¤© (${month}æœˆ${day}æ—¥ å‘¨${weekDay})`;
      } else {
        displayText = `${month}æœˆ${day}æ—¥ å‘¨${weekDay}`;
      }

      dates.push(displayText);
    }

    return dates;
  }

  /**
   * ç”Ÿæˆå°æ—¶åˆ—è¡¨ï¼ˆ00-23ï¼‰
   */
  private generateHourList(): string[] {
    const hours: string[] = [];
    for (let i = 0; i < 24; i++) {
      hours.push(i.toString().padStart(2, '0'));
    }
    return hours;
  }

  /**
   * ç”Ÿæˆåˆ†é’Ÿåˆ—è¡¨ï¼ˆ00-59ï¼Œé—´éš”5åˆ†é’Ÿï¼‰
   */
  private generateMinuteList(): string[] {
    const minutes: string[] = [];
    for (let i = 0; i < 60; i += 5) {
      minutes.push(i.toString().padStart(2, '0'));
    }
    return minutes;
  }

  /**
   * è·å–é€‰ä¸­çš„æ—¶é—´æ˜¾ç¤ºå­—ç¬¦ä¸²
   */
  private getSelectedDateDisplay(): string {
    try {
      const dateObj: DateObject | null = this.parseChineseDate(this.selectedDate);
      const hour = this.selectedHour;
      const minute = this.selectedMinute;

      if (dateObj && hour && minute) {
        return `${dateObj.month}æœˆ${dateObj.day}æ—¥ ${hour}:${minute}`;
      }
    } catch (error) {
      console.error('æ—¶é—´æ˜¾ç¤ºæ ¼å¼åŒ–é”™è¯¯:', error);
    }

    return 'è¯·é€‰æ‹©æ—¶é—´';
  }

  /**
   * è·å–é€‰ä¸­çš„æ—¶é—´æˆ³
   */
  private getSelectedTimestamp(): number {
    try {
      // è§£æé€‰ä¸­çš„ä¸­æ–‡æ—¥æœŸ
      const dateObj: DateObject | null = this.parseChineseDate(this.selectedDate);
      const hour = Number(this.selectedHour);
      const minute = Number(this.selectedMinute);

      if (dateObj && !isNaN(hour) && !isNaN(minute)) {
        const selectedDateTime = new Date(dateObj.year, dateObj.month - 1, dateObj.day, hour, minute);

        // æ£€æŸ¥æ—¶é—´æ˜¯å¦åœ¨æœªæ¥
        const now = new Date();
        if (selectedDateTime.getTime() > now.getTime()) {
          return selectedDateTime.getTime();
        } else {
          console.warn('é€‰æ‹©çš„æ—¶é—´ä¸èƒ½æ˜¯è¿‡å»æ—¶é—´');
          return -1; // è¿”å›-1è¡¨ç¤ºæ—¶é—´æ— æ•ˆ
        }
      }
    } catch (error) {
      console.error('æ—¶é—´è§£æé”™è¯¯:', error);
    }

    return -1; // è¿”å›-1è¡¨ç¤ºè§£æå¤±è´¥
  }

  /**
   * è§£æä¸­æ–‡æ—¥æœŸå­—ç¬¦ä¸²
   */
  private parseChineseDate(dateStr: string): DateObject | null {
    const now = new Date();
    const currentYear = now.getFullYear();

    if (!dateStr) {
      // å¦‚æœæ²¡æœ‰é€‰æ‹©æ—¥æœŸï¼Œè¿”å›ä»Šå¤©
      return this.createDateObject(currentYear, now.getMonth() + 1, now.getDate());
    }

    // åŒ¹é… "XæœˆXæ—¥" æ ¼å¼
    const match = dateStr.match(/(\d+)æœˆ(\d+)æ—¥/);
    if (match) {
      const month = Number(match[1]);
      const day = Number(match[2]);
      return this.createDateObject(currentYear, month, day);
    }

    // å¦‚æœæ˜¯ä»Šå¤©ã€æ˜å¤©ã€åå¤©
    const today = new Date();
    if (dateStr.includes('ä»Šå¤©')) {
      return this.createDateObject(
        today.getFullYear(),
        today.getMonth() + 1,
        today.getDate()
      );
    } else if (dateStr.includes('æ˜å¤©')) {
      const tomorrow = new Date(today);
      tomorrow.setDate(today.getDate() + 1);
      return this.createDateObject(
        tomorrow.getFullYear(),
        tomorrow.getMonth() + 1,
        tomorrow.getDate()
      );
    } else if (dateStr.includes('åå¤©')) {
      const dayAfterTomorrow = new Date(today);
      dayAfterTomorrow.setDate(today.getDate() + 2);
      return this.createDateObject(
        dayAfterTomorrow.getFullYear(),
        dayAfterTomorrow.getMonth() + 1,
        dayAfterTomorrow.getDate()
      );
    }

    // é»˜è®¤è¿”å›ä»Šå¤©
    console.warn('æ— æ³•è§£ææ—¥æœŸå­—ç¬¦ä¸²ï¼Œä½¿ç”¨ä»Šå¤©ä½œä¸ºé»˜è®¤å€¼:', dateStr);
    return this.createDateObject(
      today.getFullYear(),
      today.getMonth() + 1,
      today.getDate()
    );
  }

  /**
   * ğŸ”¥ æ–°å¢ï¼šåˆ›å»ºæ—¥æœŸå¯¹è±¡çš„æ–¹æ³•
   */
  private createDateObject(year: number, month: number, day: number): DateObject {
    return {
      year: year,
      month: month,
      day: day
    };
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DDï¼ˆå¤‡ç”¨æ–¹æ³•ï¼‰
   */
  private formatDate(date: Date): string {
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  /**
   * è·å–é€‰ä¸­çš„æ—¶é—´å­—ç¬¦ä¸²ï¼ˆåŸå§‹æ–¹æ³•ï¼Œä¿æŒå…¼å®¹ï¼‰
   */
  private getSelectedDateString(): string {
    return `${this.selectedDate} ${this.selectedHour}:${this.selectedMinute}`;
  }
}