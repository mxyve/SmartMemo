import { UIAbility, Want, Configuration, ConfigurationConstant } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { window } from '@kit.ArkUI';
import { display } from '@kit.ArkUI';
import { StorageService } from '../service/StorageService';
import { ThemeManager } from '../utils/ThemeManager';

export default class EntryAbility extends UIAbility {
  private mainWindow: window.Window | null = null;

  async onWindowStageCreate(windowStage: window.WindowStage): Promise<void> {
    try {
      this.mainWindow = windowStage.getMainWindowSync();

      // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šè®¾ç½®æ²‰æµ¸å¼å¸ƒå±€
      await this.setupImmersiveMode();

    } catch (error) {
      hilog.error(0x0000, 'SmartMemo', 'è·å–ä¸»çª—å£å¤±è´¥: %{public}s', JSON.stringify(error) ?? '');
    }

    // åˆå§‹åŒ–å­˜å‚¨æœåŠ¡
    try {
      const storageService = StorageService.getInstance();
      await storageService.init(this.context);
      hilog.info(0x0000, 'SmartMemo', 'StorageService åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
      hilog.error(0x0000, 'SmartMemo', 'StorageService åˆå§‹åŒ–å¤±è´¥: %{public}s', JSON.stringify(error) ?? '');
    }

    // åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨
    try {
      const themeManager = ThemeManager.getInstance();
      hilog.info(0x0000, 'SmartMemo', 'ThemeManager åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
      hilog.error(0x0000, 'SmartMemo', 'ThemeManager åˆå§‹åŒ–å¤±è´¥: %{public}s', JSON.stringify(error) ?? '');
    }

    // åº”ç”¨å½“å‰ä¸»é¢˜
    this.applyThemeStyle(this.context.config?.colorMode);

    // åŠ è½½é¦–é¡µ
    windowStage.loadContent('pages/SplashPage', () => {
    });
  }

  onConfigurationUpdated(config: Configuration): void {
    hilog.info(0x0000, 'SmartMemo', 'ç³»ç»Ÿé…ç½®æ›´æ–°ï¼Œå°è¯•åº”ç”¨æ–°ä¸»é¢˜...');
    this.applyThemeStyle(config?.colorMode);
  }

  /**
   * ğŸ”¥ æ–°å¢ï¼šè®¾ç½®æ²‰æµ¸å¼æ¨¡å¼
   */
  private async setupImmersiveMode(): Promise<void> {
    if (!this.mainWindow) {
      return;
    }

    try {
      // 1. è®¾ç½®å¸ƒå±€å…¨å±ï¼ˆå…³é”®æ­¥éª¤ï¼‰
      await this.mainWindow.setWindowLayoutFullScreen(true);

      // 2. å¯ç”¨ç³»ç»Ÿæ 
      await this.mainWindow.setWindowSystemBarEnable(['status', 'navigation']);

      // 3. è®¾ç½®çª—å£å…¨å±æ˜¾ç¤º
      await this.mainWindow.setFullScreen(true);

      hilog.info(0x0000, 'SmartMemo', 'æ²‰æµ¸å¼æ¨¡å¼è®¾ç½®æˆåŠŸ');

    } catch (error) {
      hilog.error(0x0000, 'SmartMemo', 'è®¾ç½®æ²‰æµ¸å¼æ¨¡å¼å¤±è´¥: %{public}s', JSON.stringify(error) ?? '');
    }
  }

  /**
   * ğŸ”¥ ä¿®æ”¹ï¼šé€‚é…æ²‰æµ¸å¼çš„ä¸»é¢˜åº”ç”¨æ–¹æ³•
   */
  private async applyThemeStyle(colorMode: number | undefined): Promise<void> {
    if (!this.mainWindow) {
      return;
    }

    try {
      // ç¡®ä¿æ²‰æµ¸å¼è®¾ç½®å·²åº”ç”¨
      await this.setupImmersiveMode();

      if (colorMode === ConfigurationConstant.ColorMode.COLOR_MODE_DARK) {
        // å¤œé—´æ¨¡å¼ - ä½¿ç”¨åŠé€æ˜é»‘è‰²
        await this.mainWindow.setWindowSystemBarProperties({
          statusBarColor: '#80000000', // åŠé€æ˜é»‘è‰²
          statusBarContentColor: '#FFFFFF', // ç™½è‰²å›¾æ ‡/æ–‡å­—
          navigationBarColor: '#80000000', // åŠé€æ˜é»‘è‰²
          navigationBarContentColor: '#FFFFFF' // ç™½è‰²å›¾æ ‡/æ–‡å­—
        });
        hilog.info(0x0000, 'SmartMemo', 'å¤œé—´æ¨¡å¼æ²‰æµ¸å¼æ ·å¼å·²åº”ç”¨');
      } else {
        // æµ…è‰²æ¨¡å¼ - ä½¿ç”¨åŠé€æ˜ç™½è‰²Zz
        await this.mainWindow.setWindowSystemBarProperties({
          statusBarColor: '#80FFFFFF', // åŠé€æ˜ç™½è‰²
          statusBarContentColor: '#000000', // é»‘è‰²å›¾æ ‡/æ–‡å­—
          navigationBarColor: '#80FFFFFF', // åŠé€æ˜ç™½è‰²
          navigationBarContentColor: '#000000' // é»‘è‰²å›¾æ ‡/æ–‡å­—
        });
        hilog.info(0x0000, 'SmartMemo', 'æµ…è‰²æ¨¡å¼æ²‰æµ¸å¼æ ·å¼å·²åº”ç”¨');
      }
    } catch (err) {
      hilog.error(0x0000, 'SmartMemo', 'åº”ç”¨æ²‰æµ¸å¼ä¸»é¢˜æ ·å¼å¤±è´¥: %{public}s', JSON.stringify(err) ?? '');
    }
  }
}